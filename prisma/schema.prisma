generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Event {
  eventUuid       String      @id @default(uuid())
  time            Int
  action          EventAction
  position        Position
  points          Int
  scoutReportUuid String
  scoutReport     ScoutReport @relation(fields: [scoutReportUuid], references: [uuid], onDelete: Cascade)

  @@index([scoutReportUuid])
}

model FeatureToggle {
  feature String  @id
  enabled Boolean @default(true)
}

model TeamMatchData {
  key           String        @id
  tournamentKey String
  matchNumber   Int           @db.SmallInt
  teamNumber    Int
  matchType     MatchType
  scoutReports  ScoutReport[]
  tournament    Tournament    @relation(fields: [tournamentKey], references: [key], onDelete: Cascade)

  @@index([tournamentKey, teamNumber])
}

model MutablePicklist {
  uuid          String      @id @default(uuid())
  teams         Int[]
  authorId      String
  name          String
  tournamentKey String?
  author        User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tournament    Tournament? @relation(fields: [tournamentKey], references: [key])
}

model ScoutReport {
  uuid                  String           @id @default(uuid())
  teamMatchKey          String
  startTime             DateTime
  notes                 String
  robotRole             RobotRole
  algaePickup           AlgaePickup
  coralPickup           CoralPickup
  bargeResult           BargeResult
  knocksAlgae           KnocksAlgae
  underShallowCage      UnderShallowCage
  robotBrokeDescription String?
  driverAbility         Int
  scouterUuid           String
  events                Event[]
  scouter               Scouter          @relation(fields: [scouterUuid], references: [uuid], onDelete: Cascade)
  teamMatchData         TeamMatchData    @relation(fields: [teamMatchKey], references: [key], onDelete: Cascade)
}

model ScouterScheduleShift {
  uuid                    String         @id @default(uuid())
  sourceTeamNumber        Int
  tournamentKey           String
  startMatchOrdinalNumber Int
  endMatchOrdinalNumber   Int
  sourceTeam              RegisteredTeam @relation(fields: [sourceTeamNumber], references: [number], onDelete: Cascade)
  tournament              Tournament     @relation(fields: [tournamentKey], references: [key], onDelete: Cascade)
  team1                   Scouter[]      @relation("Team1")
  team2                   Scouter[]      @relation("Team2")
  team3                   Scouter[]      @relation("Team3")
  team4                   Scouter[]      @relation("Team4")
  team5                   Scouter[]      @relation("Team5")
  team6                   Scouter[]      @relation("Team6")
}

model Scouter {
  uuid               String                 @id @default(uuid())
  name               String?
  archived           Boolean                @default(false)
  sourceTeamNumber   Int
  strikes            Int                    @default(0)
  scouterReliability Int                    @default(0)
  scoutReports       ScoutReport[]
  sourceTeam         RegisteredTeam         @relation(fields: [sourceTeamNumber], references: [number], onDelete: Cascade)
  team1Shifts        ScouterScheduleShift[] @relation("Team1")
  team2Shifts        ScouterScheduleShift[] @relation("Team2")
  team3Shifts        ScouterScheduleShift[] @relation("Team3")
  team4Shifts        ScouterScheduleShift[] @relation("Team4")
  team5Shifts        ScouterScheduleShift[] @relation("Team5")
  team6Shifts        ScouterScheduleShift[] @relation("Team6")

  @@index([sourceTeamNumber])
}

model SharedPicklist {
  uuid              String @id @default(uuid())
  name              String
  totalPoints       Float
  defense           Float
  driverAbility     Float
  autoPoints        Float
  algaePickups      Float
  coralPickups      Float
  barge             Float
  coralLevel1Scores Float
  coralLevel2Scores Float
  coralLevel3Scores Float
  coralLevel4Scores Float
  algaeProcessor    Float
  algaeNet          Float
  teleopPoints      Float
  feeds             Float
  authorId          String
  author            User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model Team {
  number         Int             @id
  name           String
  registeredTeam RegisteredTeam?
}

model RegisteredTeam {
  number                Int                    @id
  code                  String                 @unique
  email                 String
  emailVerified         Boolean                @default(false)
  teamApproved          Boolean                @default(false)
  website               String?
  team                  Team                   @relation(fields: [number], references: [number], onDelete: Cascade)
  scouters              Scouter[]
  scouterScheduleShifts ScouterScheduleShift[]
  slackChannels         SlackWorkspace[]
  users                 User[]
}

model EmailVerificationRequest {
  verificationCode String   @id
  email            String
  expiresAt        DateTime
  teamNumber       Int
}

model SlackWorkspace {
  workspaceId   String              @id
  owner         Int
  name          String
  authToken     String
  botUserId     String
  authUserId    String
  subscriptions SlackSubscription[]
  team          RegisteredTeam     @relation(fields: [owner], references: [number], onDelete: Cascade)
}

model SlackSubscription {
  subscriptionId      String                    @id
  channelId           String
  workspaceId         String
  subscribedEvent     WarningType
  notificationRecords SlackNotificationThread[]
  workspace           SlackWorkspace            @relation(fields: [workspaceId], references: [workspaceId], onDelete: Cascade)
}

model SlackNotificationThread {
  messageId      String            @id
  matchNumber    Int
  teamNumber     Int
  subscriptionId String
  channelId      String
  channel        SlackSubscription @relation(fields: [subscriptionId], references: [subscriptionId], onDelete: Cascade)
}

model Tournament {
  key                   String                 @id
  name                  String
  location              String?
  date                  String?
  mutablePicklists      MutablePicklist[]
  scouterScheduleShifts ScouterScheduleShift[]
  teamMatchData         TeamMatchData[]
}

model User {
  id                   String            @id
  teamNumber           Int?
  email                String            @unique
  emailVerified        Boolean           @default(false)
  username             String?
  role                 UserRole          @default(ANALYST)
  tournamentSource     String[] /// @deprecated Use tournamentSourceRule instead
  teamSource           Int[] /// @deprecated Use teamSourceRule instead
  tournamentSourceRule Json              @default("{\"mode\": \"EXCLUDE\", \"items\": []}")
  teamSourceRule       Json              @default("{\"mode\": \"EXCLUDE\", \"items\": []}")
  ApiKeys              ApiKey[]
  mutablePicklists     MutablePicklist[]
  sharedPicklists      SharedPicklist[]
  team                 RegisteredTeam?   @relation(fields: [teamNumber], references: [number], onDelete: Cascade)
}

model ApiKey {
  uuid      String    @id @unique @default(uuid())
  keyHash   String    @unique
  name      String
  userId    String
  createdAt DateTime  @default(now())
  lastUsed  DateTime?
  requests  Int       @default(0)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CachedAnalysis {
  key                    String   @id
  teamDependencies       Int[]    @default([])
  tournamentDependencies String[] @default([])
}

enum Position {
  NONE
  START_ONE
  START_TWO
  START_THREE
  START_FOUR
  LEVEL_ONE
  LEVEL_TWO
  LEVEL_THREE
  LEVEL_FOUR
  LEVEL_ONE_A
  LEVEL_ONE_B
  LEVEL_ONE_C
  LEVEL_TWO_A
  LEVEL_TWO_B
  LEVEL_TWO_C
  LEVEL_THREE_A
  LEVEL_THREE_B
  LEVEL_THREE_C
  LEVEL_FOUR_A
  LEVEL_FOUR_B
  LEVEL_FOUR_C
  GROUND_PIECE_A
  GROUND_PIECE_B
  GROUND_PIECE_C
  CORAL_STATION_ONE
  CORAL_STATION_TWO
}

enum EventAction {
  PICKUP_CORAL
  PICKUP_ALGAE
  FEED
  AUTO_LEAVE
  DEFEND
  SCORE_NET
  FAIL_NET
  SCORE_PROCESSOR
  SCORE_CORAL
  DROP_ALGAE
  DROP_CORAL
  START_POSITION
}

enum MatchType {
  QUALIFICATION
  ELIMINATION
}

enum RobotRole {
  OFFENSE
  DEFENSE
  FEEDER
  IMMOBILE
}

enum AlgaePickup {
  NONE
  GROUND
  REEF
  BOTH
}

enum KnocksAlgae {
  NO
  YES
}

enum AutoLeave {
  NO
  YES
}

enum UnderShallowCage {
  NO
  YES
}

enum CoralPickup {
  NONE
  GROUND
  STATION
  BOTH
}

enum BargeResult {
  NOT_ATTEMPTED
  PARKED
  SHALLOW
  FAILED_SHALLOW
  DEEP
  FAILED_DEEP
}

enum WarningType {
  AUTO_LEAVE
  BREAK
}

enum UserRole {
  ANALYST
  SCOUTING_LEAD
}
